<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üé• Django Video Player Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 90vw;
      height: 70vh;
      background: black;
      border: 2px solid #333;
      border-radius: 8px;
      object-fit: contain;
    }

    #status {
      margin-top: 20px;
      font-size: 1.2em;
      color: #5cf;
    }

    .overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 3em;
      background: rgba(0, 0, 0, 0.4);
      padding: 10px 20px;
      border-radius: 10px;
      display: none;
    }

    .visible {
      display: block;
    }
  </style>
</head>
<body>
<video id="player" controls>
  <source id="videoSource" src="" type="video/mp4">
  –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
</video>

<div id="overlay" class="overlay"></div>
<div id="status">‚è∏ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π...</div>

<script>
  const player = document.getElementById("player");
  const videoSource = document.getElementById("videoSource");
  const statusEl = document.getElementById("status");
  const overlay = document.getElementById("overlay");

  let lastEventTime = null;

  function showOverlay(text) {
    overlay.textContent = text;
    overlay.classList.add("visible");
    setTimeout(() => overlay.classList.remove("visible"), 1500);
  }

  async function fetchEvents() {
    try {
      const res = await fetch("/sse/events/api/");
      const data = await res.json();

      if (!data.length) return;

      // –ë–µ—Ä–µ–º —Å–∞–º–æ–µ —Å–≤–µ–∂–µ–µ —Å–æ–±—ã—Ç–∏–µ
      const latest = data[0];
      const eventTime = latest.received_at;
      if (eventTime === lastEventTime) return;
      lastEventTime = eventTime;

      const payload = JSON.parse(latest.content);
      const eventType = latest.event_type;

      console.log("üé¨ –ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ:", eventType, payload);

      switch (eventType) {
        case "play":
          const url = payload.urls?.[0]?.url;
          if (url) {
            videoSource.src = url;
            player.load();
            player.play();
            showOverlay("‚ñ∂Ô∏è PLAY");
            statusEl.textContent = "‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è: " + url;
          }
          break;

        case "pause":
          player.pause();
          showOverlay("‚è∏ –ü–ê–£–ó–ê");
          statusEl.textContent = "‚è∏ –ü–∞—É–∑–∞";
          break;

        case "setvol":
          if (payload.volume !== undefined) {
            player.volume = payload.volume;
            showOverlay("üîä " + Math.round(player.volume * 100) + "%");
            statusEl.textContent = "üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å: " + player.volume;
          }
          break;

        case "stop":
          player.pause();
          player.currentTime = 0;
          showOverlay("‚èπ –°–¢–û–ü");
          statusEl.textContent = "‚èπ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ";
          break;

        case "replay":
          player.currentTime = 0;
          player.play();
          showOverlay("üîÅ –ü–æ–≤—Ç–æ—Ä");
          statusEl.textContent = "üîÅ –ü–æ–≤—Ç–æ—Ä";
          break;

        default:
          console.log("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ:", eventType);
          break;
      }
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π:", err);
    }
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
  fetchEvents();
  setInterval(fetchEvents, 2000);
</script>
</body>
</html>
